<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Her Yol Atatürk'e Çıkar</title>
  <style>
    body { background:#0b0d10; color:#e8e9ea; font-family:sans-serif; margin:0; padding:20px; text-align:center; }
    h1 { font-size:24px; margin-bottom:16px; color:#5aa9e6; }
    canvas { background:#000; border-radius:12px; width:100%; max-width:640px; }
    input[type=file], button { margin:10px; padding:10px; font-size:14px; border-radius:8px; }
    button { background:#5aa9e6; color:#081018; border:none; font-weight:bold; cursor:pointer; }
  </style>
</head>
<body>
  <h1>Her Yol Atatürk'e Çıkar</h1>
  <p style="margin-top:-6px;color:#9aa3ad;font-size:12px">Sorun yaşıyorsanız: Dosyaları doğrudan <code>file://</code> ile açmak yerine yerel sunucu kullanın veya aşağıdaki <em>Base64 tek dosya</em> yöntemini etkinleştirin.</p>
  <input id="srcFile" type="file" accept="image/*">
  <button id="start">Hazırla ve Oynat</button>
  <p id="status"></p>
  <canvas id="cv" width="640" height="640"></canvas>

  <script>
    const cv = document.getElementById("cv");
    const ctx = cv.getContext("2d", { alpha:false });
    const srcInput = document.getElementById("srcFile");
    const statusEl = document.getElementById("status");
    const DURATION = 4000; // 4 saniye
    const SIZE = 256;

    function setStatus(t){ statusEl.textContent = t; }

    function readImage(file){
      return new Promise((resolve,reject)=>{
        const fr = new FileReader();
        fr.onload = ()=>{ const img=new Image(); img.onload=()=>resolve(img); img.onerror=reject; img.src=fr.result; };
        fr.onerror=reject; fr.readAsDataURL(file);
      });
    }

    // 1) Varsayılan: aynı klasördeki target.jpg'den yükle (aynı origin olmalı)
// 2) Alternatif: TARGET_DATA_URL dolu ise base64 gömülü hedefi kullan (fetch gerekmez).
const TARGET_DATA_URL = ""; // İsterseniz target.jpg'yi base64'e çevirip buraya yapıştırın.

function loadTarget(){
  if (TARGET_DATA_URL && TARGET_DATA_URL.startsWith("data:")) {
    // Base64 tek dosya yolu — CORS yok, 'Failed to fetch' yok
    return fetch(TARGET_DATA_URL)
      .then(r=>r.blob())
      .then(blob=>createImageBitmap(blob));
  }
  // Aynı origin'den target.jpg beklenir. Lokal testte python -m http.server önerilir.
  return fetch('target.jpg', {mode:'same-origin', cache:'no-cache'})
    .then(r=>{ if(!r.ok) throw new Error('target.jpg bulunamadı veya aynı origin değil'); return r.blob(); })
    .then(blob=>createImageBitmap(blob));
}

    function drawToGrid(img,size){
      const tmp=document.createElement("canvas");
      tmp.width=tmp.height=size;
      const c=tmp.getContext("2d");
      const ar=img.width/img.height;
      let w,h,x,y;
      if(ar>=1){w=size;h=Math.round(size/ar);x=0;y=(size-h)/2;}
      else{h=size;w=Math.round(size*ar);y=0;x=(size-w)/2;}
      c.drawImage(img,x,y,w,h);
      return c.getImageData(0,0,size,size);
    }

    function lum(r,g,b){return 0.299*r+0.587*g+0.114*b;}

    function buildMap(srcImg,tgtImg,size){
      const N=size*size;
      const src=srcImg.data,tgt=tgtImg.data;
      const s=[],t=[];
      for(let i=0;i<N;i++){const j=i*4;s[i]={idx:i,l:lum(src[j],src[j+1],src[j+2]),r:src[j],g:src[j+1],b:src[j+2]};}
      for(let i=0;i<N;i++){const j=i*4;t[i]={idx:i,l:lum(tgt[j],tgt[j+1],tgt[j+2])};}
      s.sort((a,b)=>a.l-b.l);t.sort((a,b)=>a.l-b.l);
      const from=[],to=[];
      for(let k=0;k<N;k++){const si=s[k].idx,ti=t[k].idx;
        from[k]={x:si%size,y:Math.floor(si/size),r:s[k].r,g:s[k].g,b:s[k].b};
        to[k]={x:ti%size,y:Math.floor(ti/size)};
      }
      return {from,to,size,n:N};
    }

    function drawFrame(map,a){
      const size=map.size,scale=640/size;
      ctx.fillStyle="#000";ctx.fillRect(0,0,640,640);
      for(let i=0;i<map.n;i++){
        const f=map.from[i],t=map.to[i];
        const x=f.x+(t.x-f.x)*a,y=f.y+(t.y-f.y)*a;
        ctx.fillStyle=`rgb(${f.r},${f.g},${f.b})`;
        ctx.fillRect(x*scale,y*scale,scale,scale);
      }
    }

    async function start(){
      try{
        setStatus("Görseller yükleniyor...");
        const srcImg = await readImage(srcInput.files[0]);
        const tgtImg = await loadTarget();
        const s = drawToGrid(srcImg,SIZE);
        const t = drawToGrid(tgtImg,SIZE);
        const map = buildMap(s,t,SIZE);
        setStatus("Hazır, animasyon başlıyor...");
        const start = performance.now();
        function step(ts){
          const p = Math.min(1, (ts - start)/DURATION);
          drawFrame(map, p < 0.5 ? 4*p*p*p : 1 - Math.pow(-2*p+2,3)/2);
          if(p<1) requestAnimationFrame(step);
          else setStatus("Tamamlandı ✔");
        }
        requestAnimationFrame(step);
      }catch(e){ setStatus("Hata: "+e.message); }
    }

    document.getElementById("start").onclick = start;
  </script>
</body>
</html>
